-- name: test_iceberg_metadata_delete_transform

-- ====================================================
-- SECTION 1: Setup
-- ====================================================

-- Create external catalog for Iceberg
create external catalog iceberg_transform_${uuid0}
PROPERTIES (
    "type" = "iceberg",
    "iceberg.catalog.type" = "hive",
    "iceberg.catalog.hive.metastore.uris" = "${hive_metastore_uris}",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}",
    "enable_iceberg_metadata_cache"="false"
);

-- Create database
create database iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}
properties ("location" = "oss://${oss_bucket}/test_transform_delete/${uuid0}/db");

-- ====================================================
-- SECTION 2: Year Transform Partition Tests
-- ====================================================

-- Create table with year transform partition
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform (
    id INT,
    name STRING,
    event_time DATETIME
)
PARTITION BY year(event_time);

-- Insert test data spanning multiple years
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform values
(1, 'Alice', '2022-06-15 10:00:00'),
(2, 'Bob', '2022-08-20 14:30:00'),
(3, 'Charlie', '2023-01-10 09:00:00'),
(4, 'David', '2023-12-25 16:00:00'),
(5, 'Eve', '2024-03-05 11:00:00');

-- Test 2.1: Delete with year transform partition - exact year match
-- Can not trigger metadata delete, because year function can not transform to iceberg expression
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform where year(event_time) = 2022", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform where year(event_time) = 2022;

-- Verify data
select * from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform order by id;

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform$snapshots order by committed_at desc limit 1;

-- Test 2.2: Delete with date range on year-transformed column
-- Should use position delete as exact partition match is not simple
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform where event_time >= '2023-06-01'", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform where event_time >= '2023-06-01';

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform$snapshots order by committed_at desc limit 1;

-- Cleanup year transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_year_transform force;

-- ====================================================
-- SECTION 3: Month Transform Partition Tests
-- ====================================================

-- Create table with month transform partition
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform (
    id INT,
    name STRING,
    event_date DATE
)
PARTITION BY month(event_date);

-- Insert test data
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform values
(1, 'Jan2023', '2023-01-15'),
(2, 'Jan2023b', '2023-01-25'),
(3, 'Feb2023', '2023-02-10'),
(4, 'Feb2023b', '2023-02-20'),
(5, 'Mar2023', '2023-03-05');

-- Test 3.1: Delete with month function, should use position delete
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform where month(event_date) = 1", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform where month(event_date) = 1

-- Verify data
select * from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform order by id;

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform$snapshots order by committed_at desc limit 1;

-- Test 3.2: Delete with date condition on month-transformed column
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform where event_date = '2023-02-10'", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform where event_date = '2023-02-10';

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform$snapshots order by committed_at desc limit 1;

-- Cleanup month transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_month_transform force;

-- ====================================================
-- SECTION 4: Day Transform Partition Tests
-- ====================================================

-- Create table with day transform partition
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform (
    id INT,
    name STRING,
    event_date DATE
)
PARTITION BY day(event_date);

-- Insert test data
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform values
(1, 'Day1', '2023-01-01'),
(2, 'Day1b', '2023-01-01'),
(3, 'Day2', '2023-01-02'),
(4, 'Day3', '2023-01-03'),
(5, 'Day3b', '2023-01-03');

-- Test 4.1: Delete with day function, should use position delete
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform where day(event_date) = 1", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform where day(event_date) = 1;

-- Verify data
select * from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform order by id;

-- Query snapshots table to verify operation type and deleted-data-files for METADATA DELETE
select operation, element_at(summary,'deleted-data-files') as deleted_data_files from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform$snapshots order by committed_at desc limit 1;

-- Test 4.2: Delete with date condition on day-transformed column
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform where event_date = '2023-01-02'", "ICEBERG METADATA DELETE")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform where event_date = '2023-01-02';

-- Verify data
select * from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform order by id;

-- Query snapshots table to verify operation type and deleted-data-files for METADATA DELETE
select operation, element_at(summary,'deleted-data-files') as deleted_data_files from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform$snapshots order by committed_at desc limit 1;

-- Cleanup day transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_day_transform force;

-- ====================================================
-- SECTION 5: Bucket Transform Partition Tests
-- ====================================================

-- Create table with bucket transform partition
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform (
    id INT,
    name STRING,
    category STRING
)
PARTITION BY bucket(category, 4);

-- Insert test data
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform values
(1, 'A', 'Electronics'),
(2, 'B', 'Electronics'),
(3, 'C', 'Clothing'),
(4, 'D', 'Clothing'),
(5, 'E', 'Food');

-- Test 5.1: Delete with bucket transform - exact category value
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform where category = 'Electronics'", "ICEBERG METADATA DELETE")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform where category = 'Electronics';

-- Query snapshots table to verify operation type and deleted-data-files for METADATA DELETE
select operation, element_at(summary,'deleted-data-files') as deleted_data_files from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform$snapshots order by committed_at desc limit 1;

-- Test 5.2: Delete with IN clause on bucket-transformed column
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform where category in ('Clothing', 'Food')", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform where category in ('Clothing', 'Food');

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform$snapshots order by committed_at desc limit 1;

-- Cleanup bucket transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_bucket_transform force;

-- ====================================================
-- SECTION 6: Truncate Transform Partition Tests
-- ====================================================

-- Create table with truncate transform partition
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform (
    id INT,
    name STRING,
    code STRING
)
PARTITION BY truncate(code, 3);

-- Insert test data
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform values
(1, 'A', 'ABC123'),
(2, 'B', 'ABC456'),
(3, 'C', 'DEF789'),
(4, 'D', 'DEF012'),
(5, 'E', 'XYZ345');

-- Test 6.1: Delete with truncate transform
-- Should use position delete as truncate transform requires prefix matching
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform where code = 'ABC123'", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform where code = 'ABC123';

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform$snapshots order by committed_at desc limit 1;

-- Test 6.2: Delete with LIKE prefix match on truncate-transformed column
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform where code like 'ABC%'", "ICEBERG METADATA DELETE")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform where code like 'ABC%';

-- Query snapshots table to verify operation type and deleted-data-files for METADATA DELETE
select operation, element_at(summary,'deleted-data-files') as deleted_data_files from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform$snapshots order by committed_at desc limit 1;

-- Cleanup truncate transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_truncate_transform force;

-- ====================================================
-- SECTION 7: Hour Transform Partition Tests
-- ====================================================

-- Create table with hour transform partition
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform (
    id INT,
    name STRING,
    event_time DATETIME
)
PARTITION BY hour(event_time);

-- Insert test data
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform values
(1, 'Hour10', '2023-01-01 10:30:00'),
(2, 'Hour10b', '2023-01-01 10:45:00'),
(3, 'Hour14', '2023-01-01 14:00:00'),
(4, 'Hour14b', '2023-01-01 14:30:00'),
(5, 'Hour18', '2023-01-01 18:00:00');

-- Test 7.1: Delete with hour transform - exact hour match
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform where hour(event_time) = 10", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform where hour(event_time) = 10;

-- Verify data
select * from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform order by id;

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform$snapshots order by committed_at desc limit 1;

-- Cleanup hour transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_hour_transform force;

-- ====================================================
-- SECTION 8: Mixed Transform and Identity Partition Tests
-- ====================================================

-- Create table with mixed partition transforms
create table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform (
    id INT,
    name STRING,
    event_date DATE,
    region STRING
)
PARTITION BY year(event_date), region;

-- Insert test data
insert into iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform values
(1, 'A', '2023-06-15', 'North'),
(2, 'B', '2023-07-20', 'North'),
(3, 'C', '2023-08-10', 'South'),
(4, 'D', '2024-01-05', 'East'),
(5, 'E', '2024-02-15', 'West');

-- Test 8.1: Delete matching both transform and identity partition columns
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform where year(event_date) = 2023 and region = 'North'", "ICEBERG DELETE SINK")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform where year(event_date) = 2023 and region = 'North';

-- Verify data
select * from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform order by id;

-- Query snapshots table to verify operation type and added-position-deletes for POSITION DELETE
select operation, element_at(summary,'added-position-deletes') as added_position_deletes from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform$snapshots order by committed_at desc limit 1;

-- Test 8.2: Delete with partial partition key (only year, not region) - should trigger optimization
function: assert_explain_contains("delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform where event_date = '2024-01-05'", "ICEBERG METADATA DELETE")

-- Execute delete
delete from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform where event_date = '2024-01-05';

-- Query snapshots table to verify operation type and deleted-data-files for METADATA DELETE
select operation, element_at(summary,'deleted-data-files') as deleted_data_files from iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform$snapshots order by committed_at desc limit 1;

-- Cleanup mixed transform table
drop table iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0}.test_mixed_transform force;

-- ====================================================
-- SECTION 9: Cleanup
-- ====================================================

drop database iceberg_transform_${uuid0}.iceberg_transform_db_${uuid0};
set catalog default_catalog;
drop catalog iceberg_transform_${uuid0};

shell: ossutil64 rm -rf oss://${oss_bucket}/test_transform_delete/${uuid0} >/dev/null || echo "exit 0" >/dev/null
