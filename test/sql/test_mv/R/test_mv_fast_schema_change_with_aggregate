-- name: test_mv_fast_schema_change_with_aggregate @slow
admin set frontend config('alter_scheduler_interval_millisecond' = '100');
-- result:
-- !result
drop table if exists t1_agg;
-- result:
-- !result
drop materialized view if exists test_mv_agg1;
-- result:
-- !result
CREATE TABLE t1_agg (
    dt DATE,
    c0 INT,
    c1 VARCHAR(20),
    c2 VARCHAR(200),
    c3 INT SUM,
    c4 INT SUM
) ENGINE=OLAP
AGGREGATE KEY(dt, c0, c1, c2)
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(c0) BUCKETS 48
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO t1_agg
SELECT '2026-01-01', generate_series % 10, 'val_' || CAST(generate_series AS VARCHAR),
       'desc_' || CAST(generate_series AS VARCHAR), generate_series, generate_series * 2
FROM TABLE(generate_series(1, 100));
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv_agg1
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY hash(c0)
PROPERTIES (
    "replication_num" = "1",
    "query_rewrite_consistency" = "force_mv"
)
AS
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1
FROM t1_agg
GROUP BY dt, c0;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d99-e2ac-7e9f-933c-aa96e623c3b9
-- !result
set enable_materialized_view_rewrite = false;
-- result:
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	550	1
2026-01-01	1	460	1
2026-01-01	2	470	1
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	550	1
2026-01-01	1	460	1
2026-01-01	2	470	1
-- !result
ALTER MATERIALIZED VIEW test_mv_agg1 ADD COLUMN cnt_c2 AS COUNT(c2);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg1;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c3	bigint	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1), COUNT(c2) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	550	1	1
2026-01-01	1	460	1	1
2026-01-01	2	470	1	1
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	550	1	None
2026-01-01	1	460	1	None
2026-01-01	2	470	1	None
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_0', 'desc_0', 10, 20);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-0932-70e7-986e-9980c98ba35c
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1), COUNT(c2) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	560	2	2
2026-01-01	1	460	1	1
2026-01-01	2	470	1	1
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	560	2	2
2026-01-01	1	460	1	1
2026-01-01	2	470	1	1
-- !result
ALTER TABLE t1_agg ADD COLUMN c5 VARCHAR(100);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t1_agg;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(20)	YES	true	None	
c2	varchar(200)	YES	true	None	
c5	varchar(100)	YES	true	None	
c3	int	YES	false	None	
c4	int	YES	false	None	
-- !result
ALTER TABLE t1_agg ADD COLUMN c6 INT SUM;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t1_agg;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(20)	YES	true	None	
c2	varchar(200)	YES	true	None	
c5	varchar(100)	YES	true	None	
c3	int	YES	false	None	
c4	int	YES	false	None	
c6	int	YES	false	None	
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_1', 'desc_1', 'desc_2', 15, 30, 25);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-2603-7b4a-906a-dbce58e72224
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1), COUNT(c2) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	575	3	3
2026-01-01	1	460	1	1
2026-01-01	2	470	1	1
-- !result
ALTER MATERIALIZED VIEW test_mv_agg1 ADD COLUMN sum_c6 AS SUM(c6);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg1;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c3	bigint	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
sum_c6	bigint	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1), COUNT(c2), SUM(c6) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2, SUM(c6) as sum_c6 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	575	3	3	25
2026-01-01	1	460	1	1	None
2026-01-01	2	470	1	1	None
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	575	3	3	None
2026-01-01	1	460	1	1	None
2026-01-01	2	470	1	1	None
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_2', 'desc_2', 'desc_3', 20, 40, 35);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-3e97-71d3-a0c0-a4fa7accdea6
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1), COUNT(c2), SUM(c6) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2, SUM(c6) as sum_c6 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	595	4	4	60
2026-01-01	1	460	1	1	None
2026-01-01	2	470	1	1	None
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	595	4	4	60
2026-01-01	1	460	1	1	None
2026-01-01	2	470	1	1	None
-- !result
ALTER MATERIALIZED VIEW test_mv_agg1 ADD COLUMN c5 AS c5;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg1;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c3	bigint	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
sum_c6	bigint	YES	false	None	NONE
c5	varchar(1048576)	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c5, SUM(c3), COUNT(c1), COUNT(c2), SUM(c6) FROM t1_agg GROUP BY dt, c0, c5", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, c5, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2, SUM(c6) as sum_c6 FROM t1_agg GROUP BY dt, c0, c5 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	None	560	2	2	None
2026-01-01	0	desc_2	15	1	1	25
2026-01-01	0	desc_3	20	1	1	35
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	595	4	4	60	None
2026-01-01	1	460	1	1	None	None
2026-01-01	2	470	1	1	None	None
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_3', 'desc_3', 'desc_4', 25, 50, 45);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-5b06-79e2-a705-4ebbf6be15bd
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c5, SUM(c3), COUNT(c1), COUNT(c2), SUM(c6) FROM t1_agg GROUP BY dt, c0, c5", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, c5, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, COUNT(c2) as cnt_c2, SUM(c6) as sum_c6 FROM t1_agg GROUP BY dt, c0, c5 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	None	560	2	2	None
2026-01-01	0	desc_2	15	1	1	25
2026-01-01	0	desc_3	20	1	1	35
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	15	1	1	25	desc_2
2026-01-01	0	20	1	1	35	desc_3
2026-01-01	0	25	1	1	45	desc_4
-- !result
ALTER MATERIALIZED VIEW test_mv_agg1 DROP COLUMN cnt_c2;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg1;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c3	bigint	YES	true	None	
cnt_c1	bigint	NO	true	None	
sum_c6	bigint	YES	false	None	NONE
c5	varchar(1048576)	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c5, SUM(c3), COUNT(c1), SUM(c6) FROM t1_agg GROUP BY dt, c0, c5", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, c5, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, SUM(c6) as sum_c6 FROM t1_agg GROUP BY dt, c0, c5 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	None	560	2	None
2026-01-01	0	desc_2	15	1	25
2026-01-01	0	desc_3	20	1	35
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	15	1	25	desc_2
2026-01-01	0	20	1	35	desc_3
2026-01-01	0	25	1	45	desc_4
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_4', 'desc_4', 'desc_5', 30, 60, 55);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-7ab3-7891-a68d-cfd9340c853a
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c5, SUM(c3), COUNT(c1), SUM(c6) FROM t1_agg GROUP BY dt, c0, c5", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, c5, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1, SUM(c6) as sum_c6 FROM t1_agg GROUP BY dt, c0, c5 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	None	560	2	None
2026-01-01	0	desc_2	15	1	25
2026-01-01	0	desc_3	20	1	35
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	15	1	25	desc_2
2026-01-01	0	20	1	35	desc_3
2026-01-01	0	25	1	45	desc_4
-- !result
ALTER MATERIALIZED VIEW test_mv_agg1 DROP COLUMN sum_c6;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg1;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c3	bigint	YES	true	None	
cnt_c1	bigint	NO	true	None	
c5	varchar(1048576)	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c5, SUM(c3), COUNT(c1) FROM t1_agg GROUP BY dt, c0, c5", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, c5, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1 FROM t1_agg GROUP BY dt, c0, c5 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	None	560	2
2026-01-01	0	desc_2	15	1
2026-01-01	0	desc_3	20	1
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	15	1	desc_2
2026-01-01	0	20	1	desc_3
2026-01-01	0	25	1	desc_4
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_5', 'desc_5', 'desc_6', 35, 70, 65);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-8f6a-7634-b935-2b0f8bcf9cf6
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c5, SUM(c3), COUNT(c1) FROM t1_agg GROUP BY dt, c0, c5", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, c5, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1 FROM t1_agg GROUP BY dt, c0, c5 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	None	560	2
2026-01-01	0	desc_2	15	1
2026-01-01	0	desc_3	20	1
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	15	1	desc_2
2026-01-01	0	20	1	desc_3
2026-01-01	0	25	1	desc_4
-- !result
[UC]ALTER MATERIALIZED VIEW test_mv_agg1 DROP COLUMN c5;
-- result:
[REGEX]E:.*
-- !result
INSERT INTO t1_agg VALUES ('2026-01-01', 0, 'val_6', 'desc_6', 'desc_7', 40, 80, 75);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg1 WITH SYNC MODE;
-- result:
019c2d9a-9791-703b-9cb8-f3b8678a1fc0
-- !result
function: print_hit_materialized_view("SELECT dt, c0, SUM(c3), COUNT(c1) FROM t1_agg GROUP BY dt, c0", "test_mv_agg1")
-- result:
True
-- !result
SELECT dt, c0, SUM(c3) as sum_c3, COUNT(c1) as cnt_c1 FROM t1_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	725	8
2026-01-01	1	460	1
2026-01-01	2	470	1
-- !result
SELECT * FROM test_mv_agg1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	15	1	desc_2
2026-01-01	0	20	1	desc_3
2026-01-01	0	25	1	desc_4
-- !result
DROP MATERIALIZED VIEW test_mv_agg1;
-- result:
-- !result
DROP TABLE t1_agg;
-- result:
-- !result
drop table if exists t2_agg;
-- result:
-- !result
drop materialized view if exists test_mv_agg2;
-- result:
-- !result
CREATE TABLE t2_agg (
    dt DATE,
    c0 INT,
    c1 VARCHAR(20),
    c2 INT SUM,
    c3 BIGINT SUM,
    c4 VARCHAR(100) REPLACE,
    c5 DOUBLE SUM
) ENGINE=OLAP
AGGREGATE KEY(dt, c0, c1)
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(c0)
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO t2_agg
SELECT '2026-01-01', generate_series % 5, 'val_' || CAST(generate_series AS VARCHAR),
       generate_series, generate_series * 100, 'replace_' || CAST(generate_series AS VARCHAR), generate_series * 0.5
FROM TABLE(generate_series(1, 50));
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv_agg2
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(c0)
PROPERTIES (
    "replication_num" = "1",
    "query_rewrite_consistency" = "force_mv"
)
AS
SELECT dt, c0, SUM(c2) as sum_c2, MAX(c3) as max_c3, MIN(c3) as min_c3, AVG(c5) as avg_c5
FROM t2_agg
GROUP BY dt, c0;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg2 WITH SYNC MODE;
-- result:
019c2d9a-a177-7c42-ada1-8457a8d4227c
-- !result
SELECT * FROM test_mv_agg2 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	275	27500	27500	137.5
2026-01-01	1	235	23500	23500	117.5
2026-01-01	2	245	24500	24500	122.5
-- !result
SELECT dt, c0, SUM(c2) as sum_c2, MAX(c3) as max_c3, MIN(c3) as min_c3, AVG(c5) as avg_c5
FROM t2_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	275	27500	27500	137.5
2026-01-01	1	235	23500	23500	117.5
2026-01-01	2	245	24500	24500	122.5
-- !result
ALTER MATERIALIZED VIEW test_mv_agg2 ADD COLUMN cnt_c1 AS COUNT(c1);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg2;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c2	bigint	YES	true	None	
max_c3	bigint	YES	true	None	
min_c3	bigint	YES	true	None	
avg_c5	double	YES	false	None	NONE
cnt_c1	bigint	YES	false	None	NONE
-- !result
SELECT dt, c0, sum_c2, max_c3, min_c3, avg_c5, cnt_c1 FROM test_mv_agg2 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	275	27500	27500	137.5	None
2026-01-01	1	235	23500	23500	117.5	None
2026-01-01	2	245	24500	24500	122.5	None
-- !result
SELECT dt, c0, SUM(c2) as sum_c2, MAX(c3) as max_c3, MIN(c3) as min_c3, AVG(c5) as avg_c5, COUNT(c1) as cnt_c1
FROM t2_agg GROUP BY dt, c0 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	275	27500	27500	137.5	1
2026-01-01	1	235	23500	23500	117.5	1
2026-01-01	2	245	24500	24500	122.5	1
-- !result
ALTER TABLE t2_agg ADD COLUMN c6 INT MAX;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t2_agg;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(20)	YES	true	None	
c2	int	YES	false	None	
c3	bigint	YES	false	None	
c4	varchar(100)	YES	false	None	
c5	double	YES	false	None	
c6	int	YES	false	None	
-- !result
ALTER MATERIALIZED VIEW test_mv_agg2 ADD COLUMN max_c6 AS MAX(c6);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg2;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c2	bigint	YES	true	None	
max_c3	bigint	YES	true	None	
min_c3	bigint	YES	true	None	
avg_c5	double	YES	false	None	NONE
cnt_c1	bigint	YES	false	None	NONE
max_c6	int	YES	false	None	NONE
-- !result
INSERT INTO t2_agg VALUES ('2026-01-01', 0, 'new_val', 100, 1000, 'replace_new', 10.5, 50);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg2 WITH SYNC MODE;
-- result:
019c2d9a-b6c8-70e2-bf2e-45a3873e85d9
-- !result
SELECT dt, c0, sum_c2, max_c3, min_c3, avg_c5, cnt_c1, max_c6 FROM test_mv_agg2 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	375	27500	1000	74.0	2	50
2026-01-01	1	235	23500	23500	117.5	1	None
2026-01-01	2	245	24500	24500	122.5	1	None
-- !result
ALTER MATERIALIZED VIEW test_mv_agg2 DROP COLUMN cnt_c1;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg2;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
sum_c2	bigint	YES	true	None	
max_c3	bigint	YES	true	None	
min_c3	bigint	YES	true	None	
avg_c5	double	YES	false	None	NONE
max_c6	int	YES	false	None	NONE
-- !result
DROP MATERIALIZED VIEW test_mv_agg2;
-- result:
-- !result
DROP TABLE t2_agg;
-- result:
-- !result
drop table if exists t3_agg;
-- result:
-- !result
drop materialized view if exists test_mv_agg3;
-- result:
-- !result
CREATE TABLE t3_agg (
    dt DATE,
    c0 INT,
    c1 VARCHAR(20),
    c2 INT SUM,
    c3 VARCHAR(200) REPLACE
) ENGINE=OLAP
AGGREGATE KEY(dt, c0, c1)
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(c0)
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO t3_agg
SELECT '2026-01-01', generate_series % 5, 'val_' || CAST(generate_series AS VARCHAR),
       generate_series, 'desc_' || CAST(generate_series AS VARCHAR)
FROM TABLE(generate_series(1, 50));
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv_agg3
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(c0)
PROPERTIES (
    "replication_num" = "1",
    "query_rewrite_consistency" = "force_mv"
)
AS
SELECT dt, c0, c1, SUM(c2) as total_c2
FROM t3_agg
GROUP BY dt, c0, c1;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg3 WITH SYNC MODE;
-- result:
019c2d9a-bf2f-741a-bda8-61783afb7549
-- !result
SELECT * FROM test_mv_agg3 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	1	275
2026-01-01	1	1	235
2026-01-01	2	1	245
-- !result
SELECT dt, c0, c1, SUM(c2) as total_c2 FROM t3_agg GROUP BY dt, c0, c1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	1	275
2026-01-01	1	1	235
2026-01-01	2	1	245
-- !result
ALTER MATERIALIZED VIEW test_mv_agg3 ADD COLUMN c3_expr AS approx_count_distinct(c3) DEFAULT "0";
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg3;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
total_c2	bigint	YES	false	None	NONE
c3_expr	bigint	YES	false	0	NONE
-- !result
SELECT dt, c0, c1, total_c2, c3_expr FROM test_mv_agg3 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	1	275	0
2026-01-01	1	1	235	0
2026-01-01	2	1	245	0
-- !result
SELECT dt, c0, c1, SUM(c2) as total_c2, approx_count_distinct(c3) as c3_expr FROM t3_agg GROUP BY dt, c0, c1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	1	275	1
2026-01-01	1	1	235	1
2026-01-01	2	1	245	1
-- !result
ALTER TABLE t3_agg ADD COLUMN c4 INT SUM;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t3_agg;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(20)	YES	true	None	
c2	int	YES	false	None	
c3	varchar(200)	YES	false	None	
c4	int	YES	false	None	
-- !result
ALTER MATERIALIZED VIEW test_mv_agg3 ADD COLUMN sum_c4 AS SUM(c4);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg3;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
total_c2	bigint	YES	false	None	NONE
c3_expr	bigint	YES	false	0	NONE
sum_c4	bigint	YES	false	None	NONE
-- !result
INSERT INTO t3_agg VALUES ('2026-01-01', 0, 'new_val', 200, 'new_desc', 50);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg3 WITH SYNC MODE;
-- result:
019c2d9a-d622-7903-a3c7-5e5d80c27a30
-- !result
function: print_hit_materialized_view("SELECT dt, c0, c1, SUM(c2), SUM(c4) FROM t3_agg GROUP BY dt, c0, c1", "test_mv_agg3")
-- result:
True
-- !result
SELECT dt, c0, c1, total_c2, c3_expr, sum_c4 FROM test_mv_agg3 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	1	275	1	None
2026-01-01	0	new_val	200	1	50
2026-01-01	1	1	235	1	None
-- !result
SELECT dt, c0, c1, SUM(c2) as total_c2, approx_count_distinct(c3) as c3_expr, SUM(c4) as sum_c4 FROM t3_agg GROUP BY dt, c0, c1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01	0	1	275	1	None
2026-01-01	0	new_val	200	1	50
2026-01-01	1	1	235	1	None
-- !result
ALTER MATERIALIZED VIEW test_mv_agg3 DROP COLUMN c3_expr;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg3;
-- result:
dt	date	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
total_c2	bigint	YES	false	None	NONE
sum_c4	bigint	YES	false	None	NONE
-- !result
DROP MATERIALIZED VIEW test_mv_agg3;
-- result:
-- !result
DROP TABLE t3_agg;
-- result:
-- !result
drop table if exists t4_agg;
-- result:
-- !result
drop materialized view if exists test_mv_agg4;
-- result:
-- !result
CREATE TABLE t4_agg (
    dt DATE,
    category_id INT,
    product_id INT,
    sales_amount DECIMAL(20, 2) SUM,
    quantity INT SUM,
    discount_amount DECIMAL(20, 2) SUM,
    product_name VARCHAR(100) REPLACE
) ENGINE=OLAP
AGGREGATE KEY(dt, category_id, product_id)
PARTITION BY date_trunc('month', dt)
DISTRIBUTED BY HASH(product_id) BUCKETS 16
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO t4_agg
SELECT '2026-01-01', 1, 100, 1500.50, 10, 100.25, 'Product A'
UNION ALL
SELECT '2026-01-01', 1, 101, 2500.75, 15, 200.50, 'Product A'
UNION ALL
SELECT '2026-01-01', 2, 200, 3000.00, 20, 300.00, 'Product B'
UNION ALL
SELECT '2026-01-02', 1, 100, 1800.25, 12, 150.00, 'Product A';
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv_agg4
PARTITION BY date_trunc('month', dt)
DISTRIBUTED BY HASH(category_id)
PROPERTIES (
    "replication_num" = "1",
    "query_rewrite_consistency" = "force_mv"
)
AS
SELECT dt, category_id,
       SUM(sales_amount) as total_sales,
       SUM(quantity) as total_quantity,
       SUM(discount_amount) as total_discount
FROM t4_agg
GROUP BY dt, category_id;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg4 WITH SYNC MODE;
-- result:
019c2d9a-e20c-7cb9-afe1-66d0af724132
-- !result
SELECT * FROM test_mv_agg4 ORDER BY ALL;
-- result:
2026-01-01	1	4001.25	25	300.75
2026-01-01	2	3000.00	20	300.00
2026-01-02	1	1800.25	12	150.00
-- !result
SELECT dt, category_id,
       SUM(sales_amount) as total_sales,
       SUM(quantity) as total_quantity,
       SUM(discount_amount) as total_discount
FROM t4_agg GROUP BY dt, category_id ORDER BY dt, category_id;
-- result:
2026-01-01	1	4001.25	25	300.75
2026-01-01	2	3000.00	20	300.00
2026-01-02	1	1800.25	12	150.00
-- !result
ALTER TABLE t4_agg ADD COLUMN profit DECIMAL(20, 2) SUM;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t4_agg;
-- result:
dt	date	YES	true	None	
category_id	int	YES	true	None	
product_id	int	YES	true	None	
sales_amount	decimal(38,2)	YES	false	None	
quantity	int	YES	false	None	
discount_amount	decimal(38,2)	YES	false	None	
product_name	varchar(100)	YES	false	None	
profit	decimal(38,2)	YES	false	None	
-- !result
ALTER MATERIALIZED VIEW test_mv_agg4 ADD COLUMN total_profit AS SUM(profit);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg4;
-- result:
dt	date	YES	true	None	
category_id	int	YES	true	None	
total_sales	decimal(38,2)	YES	true	None	
total_quantity	bigint	YES	true	None	
total_discount	decimal(38,2)	YES	false	None	NONE
total_profit	decimal(38,2)	YES	false	None	NONE
-- !result
INSERT INTO t4_agg VALUES ('2026-01-03', 3, 300, 5000.00, 30, 500.00, 1200.00, 1.00);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg4 WITH SYNC MODE;
-- result:
019c2d9a-f111-7add-9661-aced453a5624
-- !result
SELECT dt, category_id, total_sales, total_quantity, total_discount, total_profit FROM test_mv_agg4 ORDER BY dt, category_id;
-- result:
2026-01-01	1	4001.25	25	300.75	None
2026-01-01	2	3000.00	20	300.00	None
2026-01-02	1	1800.25	12	150.00	None
2026-01-03	3	5000.00	30	500.00	1.00
-- !result
ALTER TABLE t4_agg ADD COLUMN region VARCHAR(50);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t4_agg;
-- result:
dt	date	YES	true	None	
category_id	int	YES	true	None	
product_id	int	YES	true	None	
region	varchar(50)	YES	true	None	
sales_amount	decimal(38,2)	YES	false	None	
quantity	int	YES	false	None	
discount_amount	decimal(38,2)	YES	false	None	
product_name	varchar(100)	YES	false	None	
profit	decimal(38,2)	YES	false	None	
-- !result
ALTER MATERIALIZED VIEW test_mv_agg4 ADD COLUMN region AS region;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg4;
-- result:
dt	date	YES	true	None	
category_id	int	YES	true	None	
total_sales	decimal(38,2)	YES	true	None	
total_quantity	bigint	YES	true	None	
total_discount	decimal(38,2)	YES	false	None	NONE
total_profit	decimal(38,2)	YES	false	None	NONE
region	varchar(1048576)	YES	false	None	NONE
-- !result
INSERT INTO t4_agg VALUES ('2026-01-03', 3, 300, "Product C", 5000.00, 30, 500.00, 1200.00, 1.00);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv_agg4 WITH SYNC MODE;
-- result:
019c2d9a-fe97-72a7-83c7-29b6c5ef0744
-- !result
function: print_hit_materialized_view("SELECT dt, category_id, region, SUM(sales_amount), SUM(quantity), SUM(profit) FROM t4_agg GROUP BY dt, category_id, region", "test_mv_agg4")
-- result:
True
-- !result
SELECT dt, category_id, region, total_sales, total_quantity, total_discount, total_profit
FROM test_mv_agg4 ORDER BY dt, category_id, region;
-- result:
2026-01-01	1	None	4001.25	25	300.75	None
2026-01-01	2	None	3000.00	20	300.00	None
2026-01-02	1	None	1800.25	12	150.00	None
2026-01-03	3	None	5000.00	30	500.00	1.00
2026-01-03	3	Product C	5000.00	30	500.00	1.00
-- !result
ALTER MATERIALIZED VIEW test_mv_agg4 DROP COLUMN total_discount;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg4;
-- result:
dt	date	YES	true	None	
category_id	int	YES	true	None	
total_sales	decimal(38,2)	YES	true	None	
total_quantity	bigint	YES	true	None	
total_profit	decimal(38,2)	YES	false	None	NONE
region	varchar(1048576)	YES	false	None	NONE
-- !result
ALTER MATERIALIZED VIEW test_mv_agg4 DROP COLUMN region;
-- result:
[REGEX]E:.*
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv_agg4;
-- result:
dt	date	YES	true	None	
category_id	int	YES	true	None	
total_sales	decimal(38,2)	YES	true	None	
total_quantity	bigint	YES	true	None	
total_profit	decimal(38,2)	YES	false	None	NONE
region	varchar(1048576)	YES	false	None	NONE
-- !result
DROP MATERIALIZED VIEW test_mv_agg4;
-- result:
-- !result
DROP TABLE t4_agg;
-- result:
-- !result