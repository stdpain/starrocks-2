-- name: test_mv_fast_schema_change
admin set frontend config('alter_scheduler_interval_millisecond' = '100');
-- result:
-- !result
drop table if exists t1;
-- result:
-- !result
drop materialized view if exists test_mv1;
-- result:
-- !result
CREATE TABLE t1 (
  dt datetime,
  `c0` int(11) NULL COMMENT "",
  `c1` varchar(20) NULL COMMENT "",
  `c2` varchar(200) NULL COMMENT "",
  `c3` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`dt`, `c0`, `c1`)
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(`c0`, `c1`) BUCKETS 48
PROPERTIES (
  "replication_num" = "1"
);
-- result:
-- !result
insert into t1 SELECT '2026-01-01', generate_series % 10, generate_series, generate_series, generate_series FROM TABLE(generate_series(1, 100));
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv1 
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY hash(c0) 
PROPERTIES (
  "replication_num" = "1",
  "query_rewrite_consistency" = "force_mv"
)
AS 
SELECT dt, c0, count(c1) as cnt_c1 from t1 group by dt, c0;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d99-e28d-7a24-a292-c8b7523a20ab
-- !result
set enable_materialized_view_rewrite = false;
-- result:
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	10
2026-01-01 00:00:00	1	10
2026-01-01 00:00:00	2	10
-- !result
SELECT dt, c0, count(c1) as cnt_c1 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10
2026-01-01 00:00:00	1	10
2026-01-01 00:00:00	2	10
-- !result
ALTER MATERIALIZED VIEW test_mv1 ADD COLUMN cnt_c2 AS count(c2);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10	10
2026-01-01 00:00:00	1	10	10
2026-01-01 00:00:00	2	10	10
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	10	None
2026-01-01 00:00:00	1	10	None
2026-01-01 00:00:00	2	10	None
-- !result
ALTER MATERIALIZED VIEW test_mv1 ADD COLUMN cnt_c3 AS count(c3) DEFAULT "0";
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
cnt_c3	bigint	YES	false	0	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, count(c3) as cnt_c3 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, count(c3) as cnt_c3 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10	10	10
2026-01-01 00:00:00	1	10	10	10
2026-01-01 00:00:00	2	10	10	10
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	10	None	0
2026-01-01 00:00:00	1	10	None	0
2026-01-01 00:00:00	2	10	None	0
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-138c-7a0e-9459-478545393304
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	11	11
2026-01-01 00:00:00	1	10	10
2026-01-01 00:00:00	2	10	10
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	11	11	11
2026-01-01 00:00:00	1	10	10	10
2026-01-01 00:00:00	2	10	10	10
-- !result
ALTER TABLE t1 ADD COLUMN c4 int;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
c1	varchar(20)	YES	true	None	
c2	varchar(200)	YES	false	None	
c3	int	YES	false	None	
c4	int	YES	false	None	
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-2b23-74a0-81e1-feda2a22fbf9
-- !result
ALTER MATERIALIZED VIEW test_mv1 ADD COLUMN sum_c4 AS sum(c4);
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
cnt_c3	bigint	YES	false	0	NONE
sum_c4	bigint	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	12	12	0
2026-01-01 00:00:00	1	10	10	None
2026-01-01 00:00:00	2	10	10	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	12	12	12	None
2026-01-01 00:00:00	1	10	10	10	None
2026-01-01 00:00:00	2	10	10	10	None
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-41d2-71b3-a6ae-6df4d979c893
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	13	13	0
2026-01-01 00:00:00	1	10	10	None
2026-01-01 00:00:00	2	10	10	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	13	13	13	0
2026-01-01 00:00:00	1	10	10	10	None
2026-01-01 00:00:00	2	10	10	10	None
-- !result
ALTER MATERIALIZED VIEW test_mv1 ADD COLUMN c4 AS c4;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c2	bigint	YES	false	None	NONE
cnt_c3	bigint	YES	false	0	NONE
sum_c4	bigint	YES	false	None	NONE
c4	int	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4, c4 from t1 group by dt, c0, c4", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4, c4 from t1 group by dt, c0, c4 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	2	2	0	0
2026-01-01 00:00:00	0	11	11	None	None
2026-01-01 00:00:00	1	10	10	None	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	13	13	13	0	None
2026-01-01 00:00:00	1	10	10	10	None	None
2026-01-01 00:00:00	2	10	10	10	None	None
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-5c24-7374-bc49-dfcd5a98c216
-- !result
function: print_hit_materialized_view("select dt, c0, c4, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4 from t1 group by dt, c0, c4", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, count(c2) as cnt_c2, sum(c4) as sum_c4, c4 from t1 group by dt, c0, c4 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	3	3	0	0
2026-01-01 00:00:00	0	11	11	None	None
2026-01-01 00:00:00	1	10	10	None	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	3	3	3	0	0
2026-01-01 00:00:00	0	11	11	11	None	None
2026-01-01 00:00:00	1	10	10	10	None	None
-- !result
ALTER MATERIALIZED VIEW test_mv1 DROP COLUMN cnt_c2;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c3	bigint	YES	false	0	NONE
sum_c4	bigint	YES	false	None	NONE
c4	int	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, sum(c4) as sum_c4, c4 from t1 group by dt, c0, c4", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, sum(c4) as sum_c4, c4 from t1 group by dt, c0, c4 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	3	0	0
2026-01-01 00:00:00	0	11	None	None
2026-01-01 00:00:00	1	10	None	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	3	3	0	0
2026-01-01 00:00:00	0	11	11	None	None
2026-01-01 00:00:00	1	10	10	None	None
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-7aad-765c-8411-847fcf8ddaad
-- !result
function: print_hit_materialized_view("select dt, c0, c4, count(c1) as cnt_c1, sum(c4) as sum_c4 from t1 group by dt, c0, c4", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, sum(c4) as sum_c4, c4 from t1 group by dt, c0, c4 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	4	0	0
2026-01-01 00:00:00	0	11	None	None
2026-01-01 00:00:00	1	10	None	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL limit 3;
-- result:
2026-01-01 00:00:00	0	4	4	0	0
2026-01-01 00:00:00	0	11	11	None	None
2026-01-01 00:00:00	1	10	10	None	None
-- !result
ALTER MATERIALIZED VIEW test_mv1 DROP COLUMN sum_c4;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv1;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
cnt_c1	bigint	NO	true	None	
cnt_c3	bigint	YES	false	0	NONE
c4	int	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, c4, count(c1) as cnt_c1 from t1 group by dt, c0, c4", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, c4 from t1 group by dt, c0, c4 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	4	0
2026-01-01 00:00:00	0	11	None
2026-01-01 00:00:00	1	10	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	4	4	0
2026-01-01 00:00:00	0	11	11	None
2026-01-01 00:00:00	1	10	10	None
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-8eea-70ee-9b5d-f7e1869247ee
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1, c4 from t1 group by dt, c0, c4", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1, c4 from t1 group by dt, c0, c4 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	5	0
2026-01-01 00:00:00	0	11	None
2026-01-01 00:00:00	1	10	None
-- !result
SELECT * FROM test_mv1 ORDER BY ALL limit 3;
-- result:
2026-01-01 00:00:00	0	5	5	0
2026-01-01 00:00:00	0	11	11	None
2026-01-01 00:00:00	1	10	10	None
-- !result
[UC]ALTER MATERIALIZED VIEW test_mv1 DROP COLUMN c4;
-- result:
[REGEX]E:.*
-- !result
INSERT INTO t1 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
-- result:
019c2d9a-981a-707a-a87b-ea6b3e31347f
-- !result
function: print_hit_materialized_view("select dt, c0, count(c1) as cnt_c1 from t1 group by dt, c0", "test_mv1")
-- result:
True
-- !result
SELECT dt, c0, count(c1) as cnt_c1 from t1 group by dt, c0 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	17
2026-01-01 00:00:00	1	10
2026-01-01 00:00:00	2	10
-- !result
SELECT * FROM test_mv1 ORDER BY ALL limit 3;
-- result:
2026-01-01 00:00:00	0	6	6	0
2026-01-01 00:00:00	0	11	11	None
2026-01-01 00:00:00	1	10	10	None
-- !result
DROP MATERIALIZED VIEW test_mv1;
-- result:
-- !result
DROP TABLE t1;
-- result:
-- !result
CREATE TABLE t2 (
  dt datetime,
  `c0` int(11) NULL COMMENT "",
  `c1` varchar(20) NULL COMMENT "",
  `c2` varchar(200) NULL COMMENT "",
  `c3` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`dt`, `c0`, `c1`)
PARTITION BY date_trunc('day', dt)
DISTRIBUTED BY HASH(`c0`, `c1`) 
PROPERTIES (
"replication_num" = "1"
);
-- result:
-- !result
insert into t2 SELECT '2026-01-01', generate_series % 5, generate_series, generate_series, generate_series FROM TABLE(generate_series(1, 100));
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv2 
PARTITION BY date_trunc('day', dt)  
DISTRIBUTED BY HASH(`c0`, `c1`) 
AS 
SELECT dt, c0, c1 from t2;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv2 WITH SYNC MODE;
-- result:
019c2d9a-a57b-7efd-b3d4-7394b8c8a5fa
-- !result
function: print_hit_materialized_view("select dt, c0, c1 from t2", "test_mv2")
-- result:
True
-- !result
SELECT dt, c0, c1 FROM test_mv2 ORDER BY ALL LIMIT 3;
-- result:
2026-01-01 00:00:00	0	10
2026-01-01 00:00:00	0	100
2026-01-01 00:00:00	0	15
-- !result
SELECT dt, c0, c1 from t2 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10
2026-01-01 00:00:00	0	100
2026-01-01 00:00:00	0	15
-- !result
ALTER MATERIALIZED VIEW test_mv2 ADD COLUMN c3 AS c3 + 1;
-- result:
[REGEX]E:.*
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv2;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
-- !result
SELECT dt, c0, c1, c3 FROM test_mv2 ORDER BY ALL LIMIT 3;
-- result:
[REGEX]E:.*
-- !result
SELECT dt, c0, c1, c3 + 1 from t2 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10	11
2026-01-01 00:00:00	0	100	101
2026-01-01 00:00:00	0	15	16
-- !result
ALTER MATERIALIZED VIEW test_mv2 ADD COLUMN c3_default AS c3 + 1 DEFAULT "0";
-- result:
[REGEX]E:.*
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv2;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
-- !result
SELECT dt, c0, c1, c3, c3_default FROM test_mv2 ORDER BY ALL LIMIT 3;
-- result:
[REGEX]E:.*
-- !result
SELECT dt, c0, c1, c3 + 1, c3 + 1 from t2 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10	11	11
2026-01-01 00:00:00	0	100	101	101
2026-01-01 00:00:00	0	15	16	16
-- !result
ALTER TABLE t2 ADD COLUMN c4 int;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC t2;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
c1	varchar(20)	YES	true	None	
c2	varchar(200)	YES	false	None	
c3	int	YES	false	None	
c4	int	YES	false	None	
-- !result
ALTER MATERIALIZED VIEW test_mv2 ADD COLUMN c4 AS c4 + 1;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv2;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
c4	bigint	YES	false	None	NONE
-- !result
function: print_hit_materialized_view("select dt, c0, c1, c4 + 1 from t2", "test_mv2")
-- result:
True
-- !result
SELECT dt, c0, c1, c4 FROM test_mv2 ORDER BY dt, c0, c1, c4 LIMIT 3;
-- result:
2026-01-01 00:00:00	0	10	None
2026-01-01 00:00:00	0	100	None
2026-01-01 00:00:00	0	15	None
-- !result
SELECT dt, c0, c1, c4 + 1 from t2 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10	None
2026-01-01 00:00:00	0	100	None
2026-01-01 00:00:00	0	15	None
-- !result
INSERT INTO t2 VALUES ('2026-01-01', 0, "c1_0", "c2_0", 0, 0);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW test_mv2 WITH SYNC MODE;
-- result:
019c2d9a-c5e3-7a00-9617-238601ee35d9
-- !result
function: print_hit_materialized_view("select dt, c0, c1, c4 + 1 from t2", "test_mv2")
-- result:
True
-- !result
SELECT dt, c0, c1, c4  FROM test_mv2 ORDER BY dt, c0, c1, c4 LIMIT 3;
-- result:
2026-01-01 00:00:00	0	10	None
2026-01-01 00:00:00	0	100	None
2026-01-01 00:00:00	0	15	None
-- !result
SELECT dt, c0, c1, c4 + 1 from t2 order by ALL limit 3;
-- result:
2026-01-01 00:00:00	0	10	None
2026-01-01 00:00:00	0	100	None
2026-01-01 00:00:00	0	15	None
-- !result
ALTER MATERIALIZED VIEW test_mv2 DROP COLUMN c4;
-- result:
-- !result
function: wait_alter_table_finish()
-- result:
None
-- !result
DESC test_mv2;
-- result:
dt	datetime	YES	true	None	
c0	int	YES	true	None	
c1	varchar(1048576)	YES	true	None	
-- !result
DROP MATERIALIZED VIEW test_mv2;
-- result:
-- !result
DROP TABLE t2;
-- result:
-- !result